name: Build and Publish Distrobox Images

on:
  # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫—É main
  push:
    branches:
      - main
  # –¢–∞–∫–∂–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ GitHub
  workflow_dispatch:
  # –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ —Ä–∞–∑ –≤ –º–µ—Å—è—Ü
  schedule:
    - cron: "0 0 1 * *"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –¥–ª—è —Ç–æ–∫–µ–Ω–∞ GITHUB_TOKEN
permissions:
  contents: read
  packages: write # –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ GHCR

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    # –°—Ç—Ä–∞—Ç–µ–≥–∏—è –º–∞—Ç—Ä–∏—Ü—ã –¥–ª—è –∏—Ç–µ—Ä–∞—Ü–∏–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –∫–∞—Ç–∞–ª–æ–≥—É —Å Dockerfile
    strategy:
      fail-fast: false
      matrix:
        # –°–ø–∏—Å–æ–∫ –∫–∞—Ç–∞–ª–æ–≥–æ–≤, —Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö Dockerfile
        image: [base, openvpn, php-dev]

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      # --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker –∏ GHCR ---
      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîë Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π GITHUB_TOKEN
          password: ${{ secrets.GITHUB_TOKEN }}

      # --- –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ–≥–æ–≤ ---
      - name: üè∑Ô∏è Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          # –ò–º—è –æ–±—Ä–∞–∑–∞ –≤ GHCR –±—É–¥–µ—Ç: ghcr.io/<owner>/<repo>-<image_name>
          images: ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}-${{ matrix.image }}
          # –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ç–µ–≥–æ–≤
          tags: |
            type=sha,format=long # SHA –∫–æ–º–º–∏—Ç–∞
            type=raw,value=latest,enable=${{ github.ref == format('refs/heads/{0}', 'main') }} # "latest" –¥–ª—è –≤–µ—Ç–∫–∏ main
            type=ref,event=branch # –ò–º—è –≤–µ—Ç–∫–∏

      # --- –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è ---
      - name: üèóÔ∏è Build and Push ${{ matrix.image }} Image
        uses: docker/build-push-action@v6
        with:
          # –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–±–æ—Ä–∫–∏ - –ø–æ–¥–∫–∞—Ç–∞–ª–æ–≥ (e.g., ./base)
          context: ./${{ matrix.image }}
          # –ü—É—Ç—å –∫ Dockerfile –≤–Ω—É—Ç—Ä–∏ –ø–æ–¥–∫–∞—Ç–∞–ª–æ–≥–∞ (./base/Dockerfile)
          file: ./${{ matrix.image }}/Dockerfile
          # –í–∫–ª—é—á–∞–µ–º –ø—É–±–ª–∏–∫–∞—Ü–∏—é
          push: true
          # –¢–µ–≥–∏ –∏–∑ —à–∞–≥–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
          tags: ${{ steps.meta.outputs.tags }}
          # –ú–µ—Ç–∫–∏ –∏–∑ —à–∞–≥–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
          labels: ${{ steps.meta.outputs.labels }}
          # –í–∫–ª—é—á–µ–Ω–∏–µ –∫—ç—à–∞ –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–π —Å–±–æ—Ä–∫–∏
          cache-from: type=gha
          cache-to: type=gha,mode=max
